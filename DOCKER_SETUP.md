# Docker Setup Guide üê≥

This guide will help you run ManeYantra using Docker with secure credentials.

## Quick Start

### 1. Generate Secure Secrets

**Important**: Never use the example credentials in production!

```bash
# Run the secrets generator script
python scripts/setup_secrets.py
```

This script will:
- ‚úÖ Generate secure RabbitMQ credentials
- ‚úÖ Create a secure secret key for encryption
- ‚úÖ Create `.env` file with secure defaults
- ‚úÖ Create `docker-compose.override.yml` with generated secrets
- ‚úÖ Prompt you for optional device credentials (Eufy, TP-Link)
- ‚úÖ Set proper file permissions (600) on sensitive files

### 2. Configure Your System (Optional)

If you need custom configuration:

```bash
# Copy config templates
cp config/system.yaml.example config/system.yaml
cp config/plugins.yaml.example config/plugins.yaml

# Edit as needed
nano config/system.yaml
nano config/plugins.yaml
```

### 3. Start the System

```bash
# Build and start all services
docker compose up -d

# View logs
docker compose logs -f

# View specific service logs
docker compose logs -f maneyantra
docker compose logs -f rabbitmq
```

### 4. Access Services

- **RabbitMQ Management UI**: http://localhost:15672
  - Username: (generated by script, check your `.env` file)
  - Password: (generated by script, check your `.env` file)

### 5. Verify Everything Works

```bash
# Check service status
docker compose ps

# Check application logs
docker compose logs maneyantra | tail -20

# Check RabbitMQ is healthy
docker compose exec rabbitmq rabbitmq-diagnostics ping
```

## Managing the System

### Stop Services

```bash
# Stop all services (preserves data)
docker compose down

# Stop and remove volumes (‚ö†Ô∏è deletes all data)
docker compose down -v
```

### Restart Services

```bash
# Restart specific service
docker compose restart maneyantra

# Restart all services
docker compose restart
```

### View Logs

```bash
# Follow all logs
docker compose logs -f

# Follow specific service
docker compose logs -f maneyantra

# Last 100 lines
docker compose logs --tail=100 maneyantra
```

### Update Configuration

Configuration changes are mounted as volumes, so:

```bash
# 1. Edit config files
nano config/system.yaml

# 2. Restart the service
docker compose restart maneyantra
```

### Rebuild After Code Changes

```bash
# Rebuild and restart
docker compose up -d --build
```

## Security Best Practices

### ‚úÖ DO:
- Use the secrets generator script for production
- Keep `.env` and `docker-compose.override.yml` out of version control
- Set file permissions to 600 on `.env` file
- Regularly update your Docker images
- Use strong, unique passwords for device integrations

### ‚ùå DON'T:
- Commit `.env` or `docker-compose.override.yml` to git
- Use default credentials (`guest/guest`) in production
- Share your `.env` file
- Expose RabbitMQ ports to the internet without additional security

## File Structure

```
maneyantra/
‚îú‚îÄ‚îÄ .env                          # YOUR SECRETS (gitignored)
‚îú‚îÄ‚îÄ docker-compose.yml            # Base Docker configuration
‚îú‚îÄ‚îÄ docker-compose.override.yml   # Generated secrets (gitignored)
‚îú‚îÄ‚îÄ Dockerfile                    # Application container
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ setup_secrets.py         # Secrets generator
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ system.yaml.example      # System config template
‚îÇ   ‚îú‚îÄ‚îÄ plugins.yaml.example     # Plugin config template
‚îÇ   ‚îú‚îÄ‚îÄ system.yaml              # Your system config (gitignored)
‚îÇ   ‚îî‚îÄ‚îÄ plugins.yaml             # Your plugin config (gitignored)
‚îú‚îÄ‚îÄ data/                         # Persistent app data (gitignored)
‚îî‚îÄ‚îÄ logs/                         # Application logs (gitignored)
```

## Troubleshooting

### Can't connect to RabbitMQ

```bash
# Check if RabbitMQ is running
docker compose ps rabbitmq

# Check RabbitMQ logs
docker compose logs rabbitmq

# Check health
docker compose exec rabbitmq rabbitmq-diagnostics status
```

### Application won't start

```bash
# Check logs for errors
docker compose logs maneyantra

# Verify .env file exists
ls -la .env

# Verify credentials match between services
docker compose config
```

### Permission denied errors

```bash
# Create directories if they don't exist
mkdir -p data logs config

# Fix permissions
chmod 755 data logs config
chmod 600 .env docker-compose.override.yml
```

### Reset everything

```bash
# Stop and remove everything
docker compose down -v

# Remove generated files
rm .env docker-compose.override.yml

# Regenerate secrets
python scripts/setup_secrets.py

# Start fresh
docker compose up -d
```

## Advanced Configuration

### Custom RabbitMQ Settings

Edit `docker-compose.override.yml` to add custom RabbitMQ environment variables:

```yaml
services:
  rabbitmq:
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
      RABBITMQ_VM_MEMORY_HIGH_WATERMARK: 512MB
      RABBITMQ_DISK_FREE_LIMIT: 1GB
```

### Custom Ports

Edit `.env`:

```bash
# Change default ports
RABBITMQ_PORT=5672
RABBITMQ_MANAGEMENT_PORT=15672
```

Then update `docker-compose.override.yml`:

```yaml
services:
  rabbitmq:
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT}:15672"
```

### Running on Different Networks

If you need to connect to devices on different networks, use host networking:

```yaml
services:
  maneyantra:
    network_mode: host
```

**Note**: This removes container isolation and may not work on all platforms.

## Production Deployment

For production deployments:

1. **Use secrets management**: Consider Docker Swarm secrets or Kubernetes secrets
2. **Enable TLS**: Configure RabbitMQ with TLS certificates
3. **Set resource limits**: Add memory and CPU limits to services
4. **Enable monitoring**: Add Prometheus/Grafana for monitoring
5. **Backup strategy**: Regularly backup `data/` and `rabbitmq_data` volumes
6. **Use reverse proxy**: Put NGINX/Traefik in front for HTTPS

Example resource limits in `docker-compose.override.yml`:

```yaml
services:
  maneyantra:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

## Need Help?

- Check the main [README.md](README.md) for general documentation
- Review logs with `docker compose logs`
- Verify configuration with `docker compose config`
- Open an issue on GitHub

---

**ManeYantra** - Secure, containerized home automation üè†üîí
